name: Render Monitor (Discord)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: read

concurrency:
  group: render-monitor
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Restore state (cache)
        uses: actions/cache@v4
        with:
          path: .ping_state
          key: render-monitor-state
          restore-keys: render-monitor-state

      - name: Read last state
        id: last
        shell: bash
        run: |
          mkdir -p .ping_state
          LAST_STATE="unknown"
          LAST_HOURLY=""
          if [[ -f .ping_state/state.txt ]]; then LAST_STATE="$(cat .ping_state/state.txt)"; fi
          if [[ -f .ping_state/last_hourly_berlin.txt ]]; then LAST_HOURLY="$(cat .ping_state/last_hourly_berlin.txt)"; fi
          echo "last_state=$LAST_STATE" >> "$GITHUB_OUTPUT"
          echo "last_hourly=$LAST_HOURLY" >> "$GITHUB_OUTPUT"

      - name: Ping Render (robust)
        id: ping
        shell: bash
        run: |
          URL="https://void-seven-api.onrender.com/health"

          OUT="$(curl -sS -o /dev/null \
            -w "%{http_code} %{time_total}" \
            --connect-timeout 10 \
            --max-time 30 \
            --retry 2 \
            --retry-delay 2 \
            --retry-max-time 30 \
            "$URL" || true)"

          CODE="$(echo "$OUT" | awk '{print $1}')"
          TIME_S="$(echo "$OUT" | awk '{print $2}')"
          [[ -z "$CODE" ]] && CODE="000"
          [[ -z "$TIME_S" ]] && TIME_S="0"

          TIME_MS="$(awk -v t="$TIME_S" 'BEGIN{printf("%d", t*1000)}')"

          if [[ "$CODE" =~ ^2[0-9][0-9]$ ]]; then
            STATE="up"
          else
            STATE="down"
          fi

          echo "code=$CODE" >> "$GITHUB_OUTPUT"
          echo "time_ms=$TIME_MS" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "state=$STATE" >> "$GITHUB_OUTPUT"

      - name: Update counters (success/errors)
        id: counters
        shell: bash
        run: |
          mkdir -p .ping_state

          SUCCESS=0
          ERROR=0

          [[ -f .ping_state/success.txt ]] && SUCCESS="$(cat .ping_state/success.txt)"
          [[ -f .ping_state/error.txt ]] && ERROR="$(cat .ping_state/error.txt)"

          if [[ "${{ steps.ping.outputs.state }}" == "up" ]]; then
            SUCCESS=$((SUCCESS + 1))
          else
            ERROR=$((ERROR + 1))
          fi

          echo "$SUCCESS" > .ping_state/success.txt
          echo "$ERROR" > .ping_state/error.txt

          echo "success=$SUCCESS" >> "$GITHUB_OUTPUT"
          echo "error=$ERROR" >> "$GITHUB_OUTPUT"

      - name: Discord Activated (manual)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          NOW="$(TZ=Europe/Berlin date '+%Y-%m-%d %H:%M %Z')"
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ðŸŸ¦ ACTIVATED | ${NOW}\\nStatus: ${{ steps.ping.outputs.code }} | Zeit: ${{ steps.ping.outputs.time_ms }}ms\\nURL: ${{ steps.ping.outputs.url }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"

      - name: Discord Heartbeat
        shell: bash
        run: |
          NOW="$(TZ=Europe/Berlin date '+%H:%M')"
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ðŸ’“ HEARTBEAT | ${NOW}\\nStatus: ${{ steps.ping.outputs.code }} | Zeit: ${{ steps.ping.outputs.time_ms }}ms\\nURL: ${{ steps.ping.outputs.url }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"

      - name: Persist state
        id: state
        shell: bash
        run: |
          mkdir -p .ping_state
          CUR_STATE="${{ steps.ping.outputs.state }}"
          echo "$CUR_STATE" > .ping_state/state.txt
          echo "cur_state=$CUR_STATE" >> "$GITHUB_OUTPUT"

      - name: Discord alert (DOWN once)
        if: steps.state.outputs.cur_state == 'down' && steps.last.outputs.last_state != 'down'
        shell: bash
        run: |
          ROLE_ID="${{ secrets.DISCORD_ROLE_ID }}"
          NOW="$(TZ=Europe/Berlin date '+%Y-%m-%d %H:%M %Z')"
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"<@&${ROLE_ID}> ðŸš¨ PING DOWN | ${NOW}\\nStatus: ${{ steps.ping.outputs.code }} | Zeit: ${{ steps.ping.outputs.time_ms }}ms\\nURL: ${{ steps.ping.outputs.url }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"

      - name: Discord alert (RECOVERED once)
        if: steps.state.outputs.cur_state == 'up' && steps.last.outputs.last_state == 'down'
        shell: bash
        run: |
          NOW="$(TZ=Europe/Berlin date '+%Y-%m-%d %H:%M %Z')"
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… PING RECOVERED | ${NOW}\\nStatus: ${{ steps.ping.outputs.code }} | Zeit: ${{ steps.ping.outputs.time_ms }}ms\\nURL: ${{ steps.ping.outputs.url }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"

      - name: Discord HOURLY STATUS (success + errors)
        if: steps.ping.outputs.state == 'up'
        shell: bash
        run: |
          BERLIN_MINUTE="$(TZ=Europe/Berlin date +%M)"
          BERLIN_HOUR_KEY="$(TZ=Europe/Berlin date +%Y-%m-%d-%H)"

          # allow xx:00..xx:05 (GitHub schedule drift)
          if [[ "$BERLIN_MINUTE" -gt 5 ]]; then
            exit 0
          fi

          LAST_HOURLY="${{ steps.last.outputs.last_hourly }}"
          if [[ "$LAST_HOURLY" == "$BERLIN_HOUR_KEY" ]]; then
            exit 0
          fi

          SUCCESS="$(cat .ping_state/success.txt 2>/dev/null || echo 0)"
          ERROR="$(cat .ping_state/error.txt 2>/dev/null || echo 0)"

          NOW="$(TZ=Europe/Berlin date '+%Y-%m-%d %H:%M %Z')"

          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ðŸŸ¢ HOURLY STATUS | ${NOW}\\nâœ… Erfolgreiche Pings: ${SUCCESS}\\nâŒ Errors: ${ERROR}\\nLetzter: ${{ steps.ping.outputs.code }} | ${{ steps.ping.outputs.time_ms }}ms\\nURL: ${{ steps.ping.outputs.url }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"

          # reset counters for next hour
          echo 0 > .ping_state/success.txt
          echo 0 > .ping_state/error.txt
          echo "$BERLIN_HOUR_KEY" > .ping_state/last_hourly_berlin.txt
